import Head from 'next/head';
import 'aos/dist/aos.css';
import { useEffect, useRef, useState } from 'react';
import Image from 'next/image';
import Header from '@/components/main/UserProfile';
import MarkerList from '@/components/main/MarkerList';
import UserMarker from '@/components/main/UserMarker';
import LocationInfo from '@/components/main/LocationInfo';
import { ListItemProps } from '@/components/main/MarkerList';

declare global {
  interface Window {
    kakao: any;
  }
}

export default function Main({ projects }: any) {
  const mapRef = useRef<any>(null);

  const [selectedItem, setSelectedItem] = useState<ListItemProps | null>(null);

  const handleListItemClick = (item: ListItemProps) => {
    setSelectedItem(item);
  };

  const handleBack = () => {
    setSelectedItem(null); // ì„ íƒëœ ì•„ì´í…œ ìƒíƒœë¥¼ nullë¡œ ì„¤ì •í•˜ì—¬ LocationInfoë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
  };

  const items: ListItemProps[] = [
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘ adkfjasdfjlaskdnflaknldflansdlkfnalkfnlasnflanf', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: false },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
    { title: 'XX ë“±ë¡ì™„ë£Œ', subtitle: 'ê´€ë¦¬ì—ì„œ ì§€ì› ê°€ëŠ¥ğŸ‘', date: '2024.01.21', isBookmarked: true },
  ];



  useEffect(() => {
    const kakaoMapScript = document.createElement('script')
    kakaoMapScript.async = false
    kakaoMapScript.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=`+process.env.NEXT_PUBLIC_API_KEY+`&autoload=false&libraries=services`
    document.head.appendChild(kakaoMapScript)
    
  
    const onLoadKakaoAPI = () => {
      window.window.kakao.maps.load(() => {
        var container = document.getElementById('map');
        var options = {
          center: new window.window.kakao.maps.LatLng(37.543536094587516, 127.07741635877292),
          level: 3
        }
  
        var mapInstance = new window.kakao.maps.Map(container, options);

        var imageSrc = '/images/marker1.png',    
            imageSize = new window.kakao.maps.Size(24, 35);

        var markerImage = new window.kakao.maps.MarkerImage(imageSrc, imageSize),
            markerPosition = mapInstance.getCenter(); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤

        var marker = new window.kakao.maps.Marker({
          position: markerPosition,
          image: markerImage, // ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
          clickable: true // ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œë¥¼ í´ë¦­ëœ ë§ˆì»¤ì˜ ìœ„ì¹˜ë¡œ ì´ë™
        });

        marker.setMap(mapInstance);

        // í´ë¦­í•œ ìœ„ì¹˜ë¡œ, ë§ˆì»¤ë¥¼ ì´ë™
        window.kakao.maps.event.addListener(mapInstance, 'click', function(mouseEvent: any) {        
          var latlng = mouseEvent.latLng; 

          marker.setMap(null); //ë§ˆì»¤ í•´ì œ
          
          marker.setPosition(latlng); // ë§ˆì»¤ ìœ„ì¹˜ ë³€ê²½

          mapInstance.setCenter(latlng); // ì§€ë„ ì¤‘ì‹¬ ë³€ê²½ (í´ë¦­í•œ ìœ„ì¹˜ë¡œ)

          marker.setMap(mapInstance); // ë§ˆì»¤ ìƒì„±
        });

        mapRef.current = mapInstance; // ì§€ë„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ë³€ìˆ˜ì— í• ë‹¹
      })
    }
  
    kakaoMapScript.addEventListener('load', onLoadKakaoAPI)

  },[]);

  function zoomIn(): void {    
    if (!mapRef.current)
      return;
    
    var level = mapRef.current.getLevel();

    console.log(level);
    
    mapRef.current.setLevel(level - 1);
  }    

  function zoomOut(): void {      
    if (!mapRef.current)
      return;
    
    var level = mapRef.current.getLevel();

    console.log(level);
    
    mapRef.current.setLevel(level + 1);
  }    

  return (
    <>
      <Head>
        <title>ì¿ ì„ì¿ ì„</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        <MarkerList items={items} onListItemClick={handleListItemClick} />
        {selectedItem && <LocationInfo data={selectedItem} onBack={handleBack} />}
        <Header user="í™ê¸¸ë™" profileImage="/images/profile.png"/>
        <UserMarker />
        <div id="map" className="w-full h-screen">
            <p className="absolute top-1/2 right-0 z-20 flex flex-col rounded-lg border-2 border-black">
              <button className="w-11 h-10 bg-white rounded-t-lg flex justify-center items-center border-b-2 border-black" onClick={zoomIn}>
                <Image src="/images/zoomInBtn.png" alt="Zoom Out" width={80} height={80}/>
              </button>
              <button className="w-11 h-10 bg-white rounded-b-lg flex justify-center items-center" onClick={zoomOut}>
                <Image src="/images/zoomOutBtn.png" alt="Zoom Out" width={80} height={80} style={{transform: 'rotate(90deg)'}}/>
              </button>  
            </p>
        </div>
          </div>
        </>
  );
}